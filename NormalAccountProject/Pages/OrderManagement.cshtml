@page "/OrderManagement"
@model NormalAccountProject.Pages.OrderManagementModel
@{
    ViewData["Title"] = "Order Management";
}

<div class="section__content section__content--p30">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="overview-wrap">
                    <h2 class="title-1">Order Management</h2>
                </div>
            </div>
        </div>

        <hr>

        <div class="row mt-5">
            <div class="col-md-12">
                <div id="CustomerGridContainer" class="table-responsive" style="height: 62vh; overflow-y: auto;"></div>
                <div class="mt-3" style="text-align:center;">
                    <p>Total Customers (<span id="TotalCustomersCount">100</span>)</p>
                </div>
            </div>
        </div>

        <hr>

        <div class="row">
            <div class="col-md-12">
                <div class="copyright">
                    <p style="margin: 0;">Software Developed By : <span style="font-weight:600;">AV_Softs</span></p>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // Variable Declaration
    let userId = localStorage.getItem("userId") || "";
    let GridViewDataList = [];
    let IsUpdate = false;
    // Variable Declaration





    // Form Load
    document.addEventListener("DOMContentLoaded", async function () {
        await LoadData();
        await LoadGridViewData();
    });
    // Form Load



    async function LoadData() {
        const nInfoTab = { Userid: userId };

        return new Promise((resolve, reject) => {
            jQuery.ajax({
                type: 'POST',
                url: 'OrderManagement/nLoadCustomerRegistrationData',
                data: JSON.stringify(nInfoTab),
                contentType: 'application/json',
                success: function (response) {
                    if (response.statusId === 1) {

                        resolve();
                    } else {
                        toastr.warning("No data found for CustomerRegistration.");
                        reject();
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error LoadData details: ", xhr, status, error);
                    reject();
                }
            });
        });
    }


    // Grid View
    async function LoadGridViewData() {
        const nInfoTab = { Userid: userId };

        return new Promise((resolve, reject) => {
            jQuery.ajax({
                type: 'POST',
                url: 'OrderManagement/nLoadGridViewData',
                data: JSON.stringify(nInfoTab),
                contentType: 'application/json',
                success: function (response) {
                    if (response.statusId === 1) {

                        console.log(response.GridViewDataList);
                        GridViewDataList = response.GridViewDataList;
                        // Render Grid
                        renderCustomerGrid(GridViewDataList);
                        resolve();
                    } else {
                        toastr.warning("No data found for CustomerRegistration.");
                        reject();
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error LoadData details: ", xhr, status, error);
                    reject();
                }
            });
        });
    }
    function renderCustomerGrid(gridData) {
        const container = document.getElementById("CustomerGridContainer");

        // Clear previous grid
        container.innerHTML = "";

        if (!gridData || gridData.length === 0) {
            container.innerHTML = '<p>No records found.</p>';
            document.getElementById("TotalCustomersCount").textContent = "0";
            return;
        }

        // Determine columns dynamically (skip 'Userid', 'Type', 'CustomerId')
        const columns = Object.keys(gridData[0]).filter(col => col !== "Userid" && col !== "Type" && col !== "CustomerId" && col !== "ImagePath");

        // Table creation
        const table = document.createElement("table");
        table.className = "table table-bordered table-striped table-sm mb-0";

        // Table Header
        const thead = document.createElement("thead");
        thead.style.position = "sticky";
        thead.style.top = "0";
        thead.style.backgroundColor = "#fff";
        thead.style.zIndex = "10";

        // Header Row
        const headerRow = document.createElement("tr");

        // Actions column
        const actionTh = document.createElement("th");
        actionTh.textContent = "";
        headerRow.appendChild(actionTh);

        columns.forEach(col => {
            const th = document.createElement("th");
            th.textContent = col;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        // Filter Row
        const filterRow = document.createElement("tr");
        const emptyTh = document.createElement("th");
        filterRow.appendChild(emptyTh);

        columns.forEach(col => {
            const th = document.createElement("th");
            const input = document.createElement("input");
            input.type = "text";
            input.placeholder = `Filter ${col}`;
            input.className = "form-control form-control-sm";
            input.addEventListener("input", function () {
                filterTable(this, col);
            });
            th.appendChild(input);
            filterRow.appendChild(th);
        });
        thead.appendChild(filterRow);

        table.appendChild(thead);

        // Table Body
        const tbody = document.createElement("tbody");

        gridData.forEach(row => {
            const tr = document.createElement("tr");

            // Actions column
            const actionTd = document.createElement("td");

            const editBtn = document.createElement("button");
            editBtn.className = "btn btn-sm btn-primary me-1";
            editBtn.innerHTML = '<i class="fas fa-edit"></i>';
            editBtn.style.padding = "3px";
            editBtn.addEventListener("click", () => onEditRow(row));
            actionTd.appendChild(editBtn);

            const deleteBtn = document.createElement("button");
            deleteBtn.className = "btn btn-sm btn-danger";
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.style.padding = "3px";
            deleteBtn.addEventListener("click", () => onDeleteRow(row));
            actionTd.appendChild(deleteBtn);

            tr.appendChild(actionTd);

            // Other columns
            columns.forEach(col => {
                const td = document.createElement("td");
                if (col === "Is Active") {
                    td.innerHTML = row[col] ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-danger">In-Active</span>';
                } else {
                    td.textContent = row[col];
                }
                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        container.appendChild(table);

        // 🔹 Initial total customers count
        document.getElementById("TotalCustomersCount").textContent = tbody.rows.length;
    }
    function filterTable(input, column) {
        const table = input.closest("table");
        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.rows);
        const filterValue = input.value.toLowerCase();

        const colIndex = Array.from(table.querySelectorAll("thead tr:first-child th")).findIndex(th => th.textContent === column);

        let visibleCount = 0;

        rows.forEach(row => {
            const cellText = row.cells[colIndex].textContent.toLowerCase();
            if (cellText.includes(filterValue)) {
                row.style.display = "";
                visibleCount++;
            } else {
                row.style.display = "none";
            }
        });

        // 🔹 Update total customers count based on visible rows
        document.getElementById("TotalCustomersCount").textContent = visibleCount;
    }
    function onEditRow(rowData) {
        IsUpdate = true;
        document.getElementById("saveBtn").textContent = "Update";

        // Set values to the form using bracket notation
        document.getElementById("CustomerId").value = rowData["CustomerId"] || "";
        document.getElementById("CustomerImageAttachmentOld").value = rowData["ImagePath"] || "";
        document.getElementById("Customer").value = rowData["Customer Name"] || "";
        document.getElementById("ContactNo").value = rowData["Contact #"] || "";
        document.getElementById("TypeId").value = rowData["Type"] || ""; // Assuming TypeId is stored in Type
        document.getElementById("IsActive").checked = rowData["Is Active"] || false;
        document.getElementById("Customer").focus();

        ViewImage(rowData["ImagePath"] || "")
    }
    async function onDeleteRow(rowData) {
        console.log("Delete clicked", rowData);

        // 🔵 Step 1: Confirmation Swal
        const result = await Swal.fire({
            title: 'Are you sure?',
            text: `Do you really want to delete this customer (${rowData["Customer Name"]}) ?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes',
            cancelButtonText: 'No'
        });

        if (!result.isConfirmed) {
            // User clicked "No", exit function
            return;
        }

        const nInfoTab = {
            Userid: userId.toString(),
            CustomerId: rowData["CustomerId"].toString(),
            CustomerImageAttachmentfilenameold: rowData["ImagePath"].toString()
        };

        // 🔵 Step 2: Loader Swal
        Swal.fire({
            title: 'Please wait',
            text: 'Customer Delete is in process...',
            allowOutsideClick: false,
            allowEscapeKey: false,
            returnFocus: false,      // Prevent focus issues
            didOpen: () => Swal.showLoading()
        });

        try {
            const response = await jQuery.ajax({
                type: 'POST',
                url: 'OrderManagement/nDeleteCustomerRegistrationData',
                data: JSON.stringify(nInfoTab),
                contentType: 'application/json'
            });

            Swal.close();

            if (response.statusId === 1) {
                await Swal.fire({
                    icon: 'success',
                    title: 'Customer Deleted',
                    text: response.message || 'Customer deleted successfully',
                    returnFocus: false,
                    didClose: () => {
                        document.getElementById("Customer").focus();
                    }
                });

                // ✅ Clear Form
                nClearForm();
            } else {
                await Swal.fire({
                    icon: 'warning',
                    title: 'Customer Delete',
                    text: response.message || 'Customer delete failed',
                    returnFocus: false
                });
            }

        } catch (xhr) {
            Swal.close();

            await Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred while deleting customer',
                returnFocus: false
            });

            console.error("Delete Error:", xhr);
        }
    }
    function ViewImage(Link)
    {
        const viewBtn = document.getElementById("ViewImageBtn");
        viewBtn.style.display = "";
        viewBtn.href = Link;
        viewBtn.target = "_blank";
    }
    // Grid View






</script>

<style>
    select.form-control {
        appearance: auto;
        -webkit-appearance: auto;
        -moz-appearance: auto;
    }
</style>