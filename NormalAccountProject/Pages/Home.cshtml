@page
@model NormalAccountProject.Pages.HomeModel
@{
    ViewData["Title"] = "Home";
}

<div class="section__content section__content--p30">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="overview-wrap d-flex justify-content-between align-items-center">
                    <h2 class="title-1">Dashboard</h2>
                    <button id="refreshBtn" class="btn btn-primary">
                        <i class="fa fa-refresh" id="refreshIcon"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
        <div class="row m-t-25">
            <div class="col-sm-6 col-lg-3">
                <div class="overview-item overview-item--c1">
                    <div class="overview__inner">
                        <div class="overview-box clearfix">
                            <div class="icon">
                                <i class="zmdi zmdi-account-o"></i>
                            </div>
                            <div class="text">
                                <h2 id="Card1TotalValue"></h2>
                                <span id="Card1Caption"></span>
                            </div>
                        </div>
                        <div class="overview-chart">
                            @* <canvas id="widgetChart1"></canvas> *@
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-lg-3">
                <div class="overview-item overview-item--c2">
                    <div class="overview__inner">
                        <div class="overview-box clearfix">
                            <div class="icon">
                                <i class="zmdi zmdi-shopping-cart"></i>
                            </div>
                            <div class="text">
                                <h2 id="Card2TotalValue"></h2>
                                <span id="Card2Caption"></span>
                            </div>
                        </div>
                        <div class="overview-chart">
                            <canvas id="widgetChart2"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-lg-3">
                <div class="overview-item overview-item--c3">
                    <div class="overview__inner">
                        <div class="overview-box clearfix">
                            <div class="icon">
                                <i class="zmdi zmdi-calendar-note"></i>
                            </div>
                            <div class="text">
                                <h2 id="Card3TotalValue"></h2>
                                <span id="Card3Caption"></span>
                            </div>
                        </div>
                        <div class="overview-chart">
                            <canvas id="widgetChart3"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-lg-3">
                <div class="overview-item overview-item--c4">
                    <div class="overview__inner">
                        <div class="overview-box clearfix">
                            <div class="icon">
                                <i class="zmdi zmdi-money"></i>
                            </div>
                            <div class="text">
                                <h2 id="Card4TotalValue"></h2>
                                <span id="Card4Caption"></span>
                            </div>
                        </div>
                        <div class="overview-chart">
                            <canvas id="widgetChart4"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-9">
                <h2 class="title-1 m-b-25" id="Grid1Caption"></h2>
                <div class="table-responsive table--no-card m-b-40 custom-table-scroll">
                    <table class="table table-borderless table-striped table-earning">
                        <thead id="gridThead"></thead>
                        <tbody id="gridTbody"></tbody>
                    </table>
                </div>
            </div>
            <div class="col-lg-3">
                <h2 class="title-1 m-b-25" id="Grid2Caption"></h2>
                <div class="au-card au-card--bg-blue au-card-top-countries m-b-40">
                    <div class="au-card-inner">
                        <div class="table-responsive custom-table2-scroll">
                            <table class="table table-top-countries">
                                <tbody id="grid2Tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            @* <div class="col-lg-6">
                <div class="au-card recent-report">
                    <div class="au-card-inner">
                        <h3 class="title-2">recent reports</h3>
                        <div class="chart-info">
                            <div class="chart-info__right">
                                <div class="chart-statis">
                                    <span class="index incre">
                                        <i class="zmdi zmdi-long-arrow-up"></i>25%
                                    </span>
                                    <span class="label">products</span>
                                </div>
                                <div class="chart-statis me-0">
                                    <span class="index decre">
                                        <i class="zmdi zmdi-long-arrow-down"></i>10%
                                    </span>
                                    <span class="label">services</span>
                                </div>
                            </div>
                        </div>
                        <div class="recent-report__chart">
                            <canvas id="recent-rep-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="au-card chart-percent-card">
                    <div class="au-card-inner">
                        <h3 class="title-2 tm-b-5">Revenue Distribution</h3>
                        <div class="row no-gutters">
                            <div class="col-xl-12">
                                <div class="percent-chart">
                                    <canvas id="percent-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div> *@
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="copyright">
                    <p style="margin: 0;">Software Developed By : <span style="font-weight:600;">AV_Softs</span></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let userId = localStorage.getItem("userId") || "";


    document.addEventListener("DOMContentLoaded", async function () {
        await LoadData();
    });

    document.getElementById("refreshBtn").addEventListener("click", async function() {
        const icon = document.getElementById("refreshIcon");

        // Start rotation
        icon.classList.add("rotate");

        try {
            await LoadData(); // Your async function
        } catch (error) {
            console.error(error);
        } finally {
            // Stop rotation after LoadData completes
            icon.classList.remove("rotate");
        }
    });



    async function LoadData() {

        const nInfoTab = {
            Userid: userId
        };

        return new Promise((resolve, reject) => {
            jQuery.ajax({
                type: 'POST',
                url:'Dashboard/nLoadDashboardData',
                data: JSON.stringify(nInfoTab),
                contentType: 'application/json',
                success: function (response) {
                    if (response.statusId === 1) {
                        // Animate cards
                        animateValue("Card1TotalValue", 0, response.Card1TotalValue, 1500);
                        animateValue("Card2TotalValue", 0, response.Card2TotalValue, 1500);
                        animateValue("Card3TotalValue", 0, response.Card3TotalValue, 1500);
                        animateValue("Card4TotalValue", 0, response.Card4TotalValue, 1500);

                        // Set captions (no animation)
                        document.getElementById("Card1Caption").innerHTML = response.Card1Caption;
                        document.getElementById("Card2Caption").innerHTML = response.Card2Caption;
                        document.getElementById("Card3Caption").innerHTML = response.Card3Caption;
                        document.getElementById("Card4Caption").innerHTML = response.Card4Caption;
                        document.getElementById("Grid1Caption").innerHTML = response.Grid1Caption;
                        document.getElementById("Grid2Caption").innerHTML = response.Grid2Caption;

                        console.log(response.Grid1Data);
                        renderGrid(response.Grid1Data);

                        console.log(response.Grid2Data);
                        renderGrid2(response.Grid2Data);

                        nLoadChartsCards(response.chart2Data, response.chart3Data, response.chart4Data);

                        resolve();
                    } else {
                        toastr.warning("No data found for dashboard.");
                        reject();
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error LoadData details: ", xhr, status, error);
                    reject();
                }
            });
        });
    }

    function animateValue(id, start, end, duration) {
        let obj = document.getElementById(id);
        let startTimestamp = null;

        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString();
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };

        window.requestAnimationFrame(step);
    }
    


    // ==== Function to load all charts ====
        // Global chart references
    let widgetChart2Instance = null;
    let widgetChart3Instance = null;
    let widgetChart4Instance = null;
    function nLoadChartsCards(chart2Data, chart3Data, chart4Data) {

        // ----------- WidgetChart 2 -----------
        const chart2Texts = chart2Data.map(x => x.Text);
        const chart2Values = chart2Data.map(x => x.Value);
        const ctx2 = document.getElementById("widgetChart2");
        if (ctx2) {
            ctx2.height = 130;

            // Destroy previous instance if exists
            if (widgetChart2Instance) widgetChart2Instance.destroy();

            widgetChart2Instance = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: chart2Texts,
                    datasets: [{
                        data: chart2Values,
                        label: 'Amount',
                        backgroundColor: 'transparent',
                        borderColor: 'rgba(255,255,255,.55)',
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            titleFont: { size: 12, family: 'Poppins' },
                            titleColor: '#000',
                            bodyColor: '#000',
                            bodyFont: { family: 'Poppins' },
                            backgroundColor: '#fff',
                            cornerRadius: 3,
                            intersect: false,
                        }
                    },
                    responsive: true,
                    scales: {
                        x: { grid: { color: 'transparent' }, ticks: { font: { size: 2 }, color: 'transparent' } },
                        y: { display: false, ticks: { display: false } }
                    },
                    elements: { line: { tension: 0.00001, borderWidth: 1 }, point: { radius: 4, hitRadius: 10, hoverRadius: 4 } }
                }
            });
        }

        // ----------- WidgetChart 3 -----------
        const chart3Texts = chart3Data.map(x => x.Text);
        const chart3Values = chart3Data.map(x => x.Value);
        const ctx3 = document.getElementById("widgetChart3");
        if (ctx3) {
            ctx3.height = 130;
            if (widgetChart3Instance) widgetChart3Instance.destroy();

            widgetChart3Instance = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: chart3Texts,
                    datasets: [{
                        data: chart3Values,
                        label: 'Amount',
                        backgroundColor: 'transparent',
                        borderColor: 'rgba(255,255,255,.55)',
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            titleFont: { size: 12, family: 'Poppins' },
                            titleColor: '#000',
                            bodyColor: '#000',
                            bodyFont: { family: 'Poppins' },
                            backgroundColor: '#fff',
                            cornerRadius: 3,
                            intersect: false,
                        }
                    },
                    responsive: true,
                    scales: {
                        x: { grid: { color: 'transparent' }, ticks: { font: { size: 2 }, color: 'transparent' } },
                        y: { display: false, ticks: { display: false } }
                    },
                    elements: { line: { borderWidth: 1 }, point: { radius: 4, hitRadius: 10, hoverRadius: 4 } }
                }
            });
        }

        // ----------- WidgetChart 4 -----------
        const chart4Texts = chart4Data.map(x => x.Text);
        const chart4Values = chart4Data.map(x => x.Value);
        const ctx4 = document.getElementById("widgetChart4");
        if (ctx4) {
            ctx4.height = 115;
            if (widgetChart4Instance) widgetChart4Instance.destroy();

            widgetChart4Instance = new Chart(ctx4, {
                type: 'bar',
                data: {
                    labels: chart4Texts,
                    datasets: [{
                        label: "Amount",
                        data: chart4Values,
                        borderColor: "transparent",
                        borderWidth: "0",
                        backgroundColor: "rgba(255,255,255,.3)"
                    }]
                },
                options: {
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    responsive: true,
                    scales: {
                        x: { grid: { color: 'transparent' }, ticks: { font: { size: 2 }, color: 'transparent' } },
                        y: { display: false, ticks: { display: false } }
                    },
                    elements: { rectangle: { borderWidth: 0 } }
                }
            });
        }
    }


    // ==== Function to load All Grids ====
    function renderGrid(gridData) {

        if (!gridData || gridData.length === 0) return;

        const thead = document.getElementById("gridThead");
        const tbody = document.getElementById("gridTbody");

        thead.innerHTML = "";
        tbody.innerHTML = "";

        /* ---------- THEAD (Dynamic) ---------- */
        const headerRow = document.createElement("tr");

        Object.keys(gridData[0]).forEach(key => {
            const th = document.createElement("th");
            th.innerText = key.replace(/([A-Z])/g, ' $1').toLowerCase();

            if (["price", "quantity", "total"].includes(key)) {
                th.classList.add("text-end");
            }

            headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);

        /* ---------- TBODY (Dynamic Rows) ---------- */
        gridData.forEach(row => {
            const tr = document.createElement("tr");

            Object.entries(row).forEach(([key, value]) => {
                const td = document.createElement("td");
                td.innerText = value;

                if (["price", "quantity", "total"].includes(key)) {
                    td.classList.add("text-end");
                }

                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });
    }
    function renderGrid2(gridData) {
        if (!gridData || gridData.length === 0) return;

        const tbody = document.getElementById("grid2Tbody");
        tbody.innerHTML = "";

        gridData.forEach(row => {
            const tr = document.createElement("tr");

            // Pehla column (Name / dynamic)
            const td1 = document.createElement("td");
            td1.innerText = Object.values(row)[0]; // pehla column
            tr.appendChild(td1);

            // Doosra column (Value / dynamic)
            const td2 = document.createElement("td");
            td2.innerText = Object.values(row)[1]; // doosra column
            td2.classList.add("text-end");
            tr.appendChild(td2);

            tbody.appendChild(tr);
        });
    }

</script>

<style>
    .custom-table-scroll {
        max-height: 520px; /* ~8 rows ke liye scroll */
        overflow-y: auto;
    }

    /* Sticky thead */
    .custom-table-scroll thead th {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .custom-table2-scroll {
        max-height: 470px; /* 470px ke baad scroll */
        overflow-y: auto;
    }

    @@keyframes rotateIcon {
        from

    {
        transform: rotate(0deg);
    }

    to {
        transform: rotate(360deg);
    }

    }

    .rotate {
        animation: rotateIcon 1s linear infinite;
    }

</style>